#!/usr/bin/env bash

set -e

CONFIG_PATH=/data/options.json

MQTT_HOST=$(jq -r '.mqtt_host // "core-mosquitto"' $CONFIG_PATH)
MQTT_PORT=$(jq -r '.mqtt_port // 1883' $CONFIG_PATH)
MQTT_USER=$(jq -r '.mqtt_user // empty' $CONFIG_PATH)
MQTT_PASS=$(jq -r '.mqtt_password // empty' $CONFIG_PATH)

MQTT_BASE="mqtt://$MQTT_HOST:$MQTT_PORT"
if [ -n "$MQTT_USER" ]; then
    MQTT_BASE="$MQTT_BASE,user=$MQTT_USER"
    if [ -n "$MQTT_PASS" ]; then
        MQTT_BASE="$MQTT_BASE,pass=$MQTT_PASS"
    fi
fi

COMMON_FLAGS="-F json -F log"

jq -c '.dongles[]' $CONFIG_PATH | while read -r dongle; do
    DEVICE=$(echo "$dongle" | jq -r '.device // "0"')
    FREQ=$(echo "$dongle" | jq -r '.frequency // 433')

    case "$FREQ" in
        433)
            TUNE=433920000
            RATE=250k
            ;;
        915)
            TUNE=915000000
            RATE=1M
            ;;
        *)
            echo "Invalid frequency $FREQ for device $DEVICE - skipping"
            continue
            ;;
    esac

    PREFIX="${FREQ}mhz"

    echo "[$(date '+%H:%M:%S')] Starting RTL_433 device $DEVICE tuned to $TUNE Hz with sample rate $RATE"

    rtl_433 -d "$DEVICE" -f "$TUNE" -s "$RATE" $COMMON_FLAGS \
        -F "$MQTT_BASE,retain=0,devices=rtl_433/${PREFIX}/[model]/[id]" &
done

wait