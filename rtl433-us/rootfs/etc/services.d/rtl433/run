#!/usr/bin/env bash

set -e

CONFIG_PATH=/data/options.json

MQTT_HOST=$(jq -r '.mqtt_host // "core-mosquitto"' $CONFIG_PATH)
MQTT_PORT=$(jq -r '.mqtt_port // 1883' $CONFIG_PATH)
MQTT_USER=$(jq -r '.mqtt_user // empty' $CONFIG_PATH)
MQTT_PASS=$(jq -r '.mqtt_password // empty' $CONFIG_PATH)

MQTT_URL="mqtt://$MQTT_HOST:$MQTT_PORT"
if [ -n "$MQTT_USER" ]; then
    MQTT_URL="$MQTT_URL,user=$MQTT_USER"
    if [ -n "$MQTT_PASS" ]; then
        MQTT_URL="$MQTT_URL,pass=$MQTT_PASS"
    fi
fi

COMMON_FLAGS="-q -C si -M utc"

jq -c '.dongles[]' $CONFIG_PATH | while read -r dongle; do
    DEVICE=$(echo "$dongle" | jq -r '.device // "0"')
    FREQ=$(echo "$dongle" | jq -r '.frequency // 433')

    if [ "$FREQ" != "433" ] && [ "$FREQ" != "915" ]; then
        echo "Invalid frequency $FREQ for device $DEVICE - skipping"
        continue
    fi

    if [ "$FREQ" = "433" ]; then
        TUNE=433920000
        RATE=250k
    else
        TUNE=915000000
        RATE=1M
    fi

    PREFIX="${FREQ}mhz"

    echo "Starting rtl_433 device $DEVICE on $FREQ MHz (tune $TUNE Hz, rate $RATE)"

    rtl_433 -d "$DEVICE" -f "$TUNE" -s "$RATE" $COMMON_FLAGS \
        -F "$$ MQTT_URL,retain=1,devices=rtl_433/ $${PREFIX}/[model]/[id]" &
done

wait